<!-- @format -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>WS Chat Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      #chat {
        border: 1px solid #ccc;
        padding: 10px;
        height: 300px;
        overflow-y: auto;
        margin-bottom: 10px;
      }
      .msg {
        margin: 5px 0;
      }
      .host {
        color: blue;
      }
      .guest {
        color: green;
      }
      .original {
        font-style: italic;
        color: #666;
      }
      .translated {
        font-weight: bold;
      }
      #suggestions {
        margin-top: 10px;
      }
      .suggestion-btn {
        margin: 3px;
        padding: 5px 10px;
        border: 1px solid #ccc;
        background: #f9f9f9;
        cursor: pointer;
        border-radius: 4px;
      }
      .suggestion-btn:hover {
        background: #e6e6e6;
      }
      .save-btn {
        margin-left: 5px;
        padding: 2px 5px;
        font-size: 12px;
        cursor: pointer;
      }
      #autoModeBtn {
        margin-left: 10px;
        padding: 5px 10px;
        cursor: pointer;
        display: none; /* hidden for guests */
      }
    </style>
  </head>
  <body>
    <h2>WebSocket Chat Test</h2>

    <label>Session ID: <input id="sessionId" value="test123" /></label><br />
    <label>
      Role:
      <select id="role" onchange="toggleAutoBtn()">
        <option value="host">Host</option>
        <option value="guest">Guest</option>
      </select>
    </label>
    <br /><br />

    <button onclick="connect()">Connect</button>
    <button id="autoModeBtn" onclick="toggleAutoMode()">
      üöÄ Auto Mode: OFF
    </button>
    <div id="status">Not connected</div>

    <div id="chat"></div>

    <input id="msgInput" placeholder="Type a message..." style="width: 70%" />
    <button onclick="sendMessage()">Send</button>

    <div id="suggestions"></div>
    <div id="memories"></div>
    <script>
      let ws;
      let autoMode = false;

      // Persistent user_id for memory purposes
      let userId = localStorage.getItem("userId");
      if (!userId) {
        userId = "user-" + Math.random().toString(36).substr(2, 9);
        localStorage.setItem("userId", userId);
      }

      function connect() {
        const sessionId = document.getElementById("sessionId").value;
        const role = document.getElementById("role").value;
        ws = new WebSocket(
          `ws://localhost:8000/api/v1/ws/${sessionId}/${role}/${userId}`
        );

        ws.onopen = () => {
          document.getElementById("status").innerText = "Connected ‚úÖ";
        };

        ws.onmessage = (event) => {
          const data = JSON.parse(event.data);

          if (data.type === "suggestions") {
            showSuggestions(data.suggestions);
            return;
          }

          const chat = document.getElementById("chat");
          const div = document.createElement("div");
          div.className = `msg ${data.from}`;
          div.innerHTML = `
            <span>[${data.from}]</span> 
            <span class="original">(${data.original})</span> ‚Üí 
            <span class="translated">${data.translated}</span>
            <button class="save-btn" onclick="saveMemory('${data.original.replace(
              /'/g,
              "\\'"
            )}')">üíæ Save</button>
          `;
          chat.appendChild(div);
          chat.scrollTop = chat.scrollHeight;
        };

        ws.onclose = () => {
          document.getElementById("status").innerText = "Disconnected ‚ùå";
        };
      }

      function sendMessage(text = null) {
        const input = document.getElementById("msgInput");
        const msg = text || input.value;
        if (!msg) return;

        let payload = { message: msg };

        const role = document.getElementById("role").value;
        if (role === "host" && autoMode) {
          payload.autoKey = "auto-" + Date.now();
          payload.autoModeEnabled = true;
        } else {
          payload.autoModeEnabled = false;
        }
        ws.send(JSON.stringify(payload));
        input.value = "";
        clearSuggestions();
      }

      function showSuggestions(suggestions) {
        const container = document.getElementById("suggestions");
        container.innerHTML = "<b>Suggestions:</b><br/>";
        suggestions.forEach((s) => {
          const btn = document.createElement("button");
          btn.className = "suggestion-btn";
          btn.innerText = s;
          btn.onclick = () => sendMessage(s);
          container.appendChild(btn);
        });
      }

      function clearSuggestions() {
        document.getElementById("suggestions").innerHTML = "";
      }

      // Save memory for a specific message
      function saveMemory(message) {
        fetch("http://localhost:8000/api/v1/memory/save", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            user_id: userId,
            message: message,
          }),
        })
          .then((res) => res.json())
          .then((data) => {
            console.log("Memory saved:", data);
            alert("Message saved to memory ‚úÖ");
          })
          .catch((err) => console.error(err));
      }

      function toggleAutoBtn() {
        const role = document.getElementById("role").value;
        document.getElementById("autoModeBtn").style.display =
          role === "host" ? "inline-block" : "none";
      }

      function toggleAutoMode() {
        autoMode = !autoMode;
        document.getElementById("autoModeBtn").innerText = autoMode
          ? "üöÄ Auto Mode: ON"
          : "üöÄ Auto Mode: OFF";
      }
      function loadMemories() {
        fetch(`http://localhost:8000/api/v1/memory/${userId}`)
          .then((res) => res.json())
          .then((data) => {
            const container = document.getElementById("memories");
            container.innerHTML = "<h3>Saved Memories:</h3>";

            if (!data.memories || data.memories.length === 0) {
              container.innerHTML += "<p>No memories found.</p>";
              return;
            }

            const list = document.createElement("ul");
            data.memories.forEach((mem) => {
              const li = document.createElement("li");
              li.innerHTML = `
            <b>Message:</b> ${mem || ""} <br/>
          `;
              li.style.marginBottom = "8px";
              list.appendChild(li);
            });

            container.appendChild(list);
          })
          .catch((err) => console.error("Error loading memories:", err));
      }
      // Initialize role state on page load
      toggleAutoBtn();
      loadMemories();
    </script>
  </body>
</html>
